#!/bin/bash

firstsetuprun () {
	echo 'Welcome to chronOS! You will now have to set up the Admin user, which you will be relying on for sudo commands.'
	echo 'Make the password something other than your current account.'
	echo 'The current password for Admin is "default".'

	pkexec passwd Admin

	echo "Great! Now, just sit back and relax while we do some extra tasks..."

	echo "Step 1: Reinstall audio drivers"
	chruln override remove chromebook-linux-audio
	chruln override install chromebook-linux-audio

	echo "Step 2: Install system flatpaks"
	echo "Warning - This step requires priviliges, type in your Admin password when it asks you to!"
	flatpak install --system flathub it.mijorus.gearlever \
		de.schmidhuberj.tubefeeder \
		com.jeffser.Alpaca \
		com.spotify.Client

	echo "Step 3: Configure flatpak repositories"
	echo "Warning - This step requires priviliges, type in your Admin password when it asks you to!"
	flatpak --system remove-remote flathub
	flatpak --system remove-remote fedora
	flatpak remote-add --if-not-exists --user flathub https://dl.flathub.org/repo/flathub.flatpakrepo

	echo "Step 4: Install Brew package manager"
	bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
	test -d $HOME/.linuxbrew && eval "$($HOME/.linuxbrew/bin/brew shellenv)"
	test -d /home/linuxbrew/.linuxbrew && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
	echo "eval \"\$($(brew --prefix)/bin/brew shellenv)\"" >> ~/.bashrc

	echo "Step 5: Cleanup"
	echo "Warning - This step requires priviliges, type in your Admin password!"
	pkexec gpasswd --delete $(whoami) wheel
	pkexec echo "true" >> /etc/firstsetup/misc/setup.lock

	echo 'Nice! Youre all set now!'
	echo 'Happy experimenting!'
}

if [[ "$(cat /etc/firstsetup/misc/setup.lock)" != "false" ]];
	then
		/bin/false
	else
		firstsetuprun
fi